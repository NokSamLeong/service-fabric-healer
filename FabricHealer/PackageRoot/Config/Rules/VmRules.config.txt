## Logic rules for Virtual Machine level repairs in the cluster. Only OS reboot is supported today.

## First, check if we are inside run interval. If so, then cut (!).
Mitigate() :- CheckInsideRunInterval(RunInterval=02:00:00), !.

## TimeScopedRestartVM is an internal predicate to check for the number of times a VM repair has run to completion within a supplied time window. 
## If Completed VM Repair count is less then supplied value, then run RestartVM mitigation.
TimeScopedRestartVM(?count, ?time) :- GetRepairHistory(?repairCount, TimeWindow=?time), ?repairCount < ?count, RestartVM().

## Percent Memory in Use (of total physical).
Mitigate(MetricName="MemoryPercent", MetricValue=?MetricValue) :- ?MetricValue >= 95,
    	TimeScopedRestartVM(4, TimeWindow=08:00:00).

## File Handles/FDs.
## Percent Allocated, System-wide.
Mitigate(OS="Linux", MetricName="FileHandlesPercent", MetricValue=?MetricValue) :- ?MetricValue >= 95,
    	TimeScopedRestartVM(2, TimeWindow=08:00:00).

## Total Allocated, System-wide.
Mitigate(OS="Linux", MetricName="FileHandles", MetricValue=?MetricValue) :- ?MetricValue >= 1000000,
    	TimeScopedRestartVM(2, TimeWindow=08:00:00).
