## Logic rules for Virtual Machine level repairs in the cluster. Only OS reboot is supported today.

## Mitigate Named Arguments related to VM repair - Corresponding data is supplied by FabricObserver, Renamed for brevity by FH.
## | Argument Name             | Definition                                                                                   |
## |---------------------------|----------------------------------------------------------------------------------------------|
## | NodeName                  | Name of the node                                                                             | 
## | NodeType                  | Type of node                                                                                 |  
## | FOErrorCode               | Error Code emitted by FO (e.g. "FO002")                                                      | 
## | MetricName                | Name of the resource supplied by FO (e.g., CpuPercent or MemoryMB, etc.)                     |   
## | MetricValue               | Corresponding Metric Value supplied by FO (e.g. "85" indicating 85% CPU usage)               | 
## | OS                        | The name of the OS from which the FO data was collected (Linux or Windows)                   |

        
## VM-related Metric Names.
## | Name                      |                                                                                    
## |---------------------------|
## | ActiveTcpPorts            |                                         
## | CpuPercent                |    
## | EphemeralPorts            |    
## | MemoryMB                  | 
## | MemoryPercent             | 
## | FileHandles               | 
## | FileHandlesPercent        | 

## First, check if we are inside run interval. If so, then cut (!).
Mitigate() :- CheckInsideRunInterval(RunInterval=02:00:00), !.

## TimeScopedRestartVM is an internal predicate to check for the number of times a VM reboot repair has run to completion within a supplied time window. 
## If Completed VM Repair count is less then supplied value, then run RestartVM mitigation.
TimeScopedRestartVM(?count, ?time) :- GetRepairHistory(?repairCount, TimeWindow=?time),
    ?repairCount < ?count, 
    RestartVM().

## Percent Memory in Use (of total physical).
Mitigate(MetricName="MemoryPercent", MetricValue=?MetricValue) :- ?MetricValue >= 95,
    	TimeScopedRestartVM(4, 08:00:00).

## File Handles/FDs. Linux-only.
## Percent Allocated, System-wide.
Mitigate(MetricName="FileHandlesPercent", MetricValue=?MetricValue, OS="Linux") :- ?MetricValue >= 95,
    	TimeScopedRestartVM(2, 08:00:00).

## Total Allocated, System-wide.
Mitigate(MetricName="FileHandles", MetricValue=?MetricValue, OS="Linux") :- ?MetricValue >= 1000000,
    	TimeScopedRestartVM(2, 08:00:00).